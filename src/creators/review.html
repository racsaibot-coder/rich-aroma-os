<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1410">
    <title>Revisar Contenido | Rich Aroma</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --espresso: #5D4037;
            --caramel: #D4A574;
            --dark-bg: #0f0d0b;
            --card-bg: #1a1714;
            --text: #f5f0eb;
            --text-muted: #8a8078;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --gold: #fbbf24;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 1rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .header h1 { font-size: 1.3rem; }
        .back-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .stats-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-pill {
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        .stat-pill.pending { border: 2px solid var(--warning); }
        .stat-pill .count { font-weight: 700; color: var(--warning); }

        .submission-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--warning);
        }
        .submission-card.reviewed {
            border-left-color: var(--text-muted);
            opacity: 0.6;
        }

        .submission-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        .submission-creator {
            font-weight: 600;
        }
        .submission-phone {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .submission-platform {
            background: var(--espresso);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .submission-link {
            display: block;
            background: var(--dark-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        .submission-link a {
            color: var(--caramel);
            font-size: 0.9rem;
            word-break: break-all;
        }
        .submission-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        .submission-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .review-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .review-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .review-btn.approve { background: var(--success); color: white; }
        .review-btn.deny { background: var(--danger); color: white; }
        .review-btn.open { background: var(--espresso); color: white; }
        .review-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .points-input {
            background: var(--dark-bg);
            border: 1px solid var(--espresso);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text);
            width: 80px;
            text-align: center;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }
        .empty-icon { font-size: 3rem; margin-bottom: 1rem; }

        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .filter-tab {
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
        }
        .filter-tab.active {
            background: var(--caramel);
            color: #000;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Revisar Contenido</h1>
        <a href="/" class="back-link">‚Üê Volver</a>
    </div>

    <div class="stats-bar">
        <div class="stat-pill pending">
            <span class="count" id="pendingCount">0</span> pendientes
        </div>
        <div class="stat-pill">
            <span id="todayCount">0</span> hoy
        </div>
    </div>

    <div class="filter-tabs">
        <button class="filter-tab active" onclick="setFilter('pending')">Pendientes</button>
        <button class="filter-tab" onclick="setFilter('approved')">Aprobados</button>
        <button class="filter-tab" onclick="setFilter('denied')">Rechazados</button>
        <button class="filter-tab" onclick="setFilter('all')">Todos</button>
    </div>

    <div id="submissionsList"></div>

    <script>
        let submissions = [];
        let currentFilter = 'pending';

        async function loadSubmissions() {
            try {
                const res = await fetch('/api/creator-submissions');
                submissions = await res.json();
                updateStats();
                renderSubmissions();
            } catch (e) {
                console.error('Error loading submissions');
            }
        }

        function updateStats() {
            const pending = submissions.filter(s => s.status === 'pending').length;
            const today = submissions.filter(s => {
                const d = new Date(s.submittedAt);
                const now = new Date();
                return d.toDateString() === now.toDateString();
            }).length;
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('todayCount').textContent = today;
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(t => 
                t.classList.toggle('active', t.textContent.toLowerCase().includes(filter) || 
                    (filter === 'all' && t.textContent === 'Todos')));
            renderSubmissions();
        }

        function renderSubmissions() {
            const filtered = currentFilter === 'all' 
                ? submissions 
                : submissions.filter(s => s.status === currentFilter);

            const list = document.getElementById('submissionsList');
            
            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">‚úÖ</div>
                        <div>No hay contenido ${currentFilter === 'pending' ? 'pendiente' : 'para mostrar'}</div>
                    </div>
                `;
                return;
            }

            list.innerHTML = filtered.map(s => `
                <div class="submission-card ${s.status !== 'pending' ? 'reviewed' : ''}" id="sub-${s.id}">
                    <div class="submission-top">
                        <div>
                            <div class="submission-creator">${s.creatorName || 'Creador'}</div>
                            <div class="submission-phone">${formatPhone(s.phone)}</div>
                        </div>
                        <div class="submission-platform">${getPlatformIcon(s.platform)} ${s.platform}</div>
                    </div>
                    <div class="submission-link">
                        <a href="${s.link}" target="_blank">${s.link}</a>
                    </div>
                    ${s.description ? `<div class="submission-desc">"${s.description}"</div>` : ''}
                    <div class="submission-time">Enviado: ${formatDate(s.submittedAt)}</div>
                    
                    ${s.status === 'pending' ? `
                        <div class="review-actions">
                            <button class="review-btn open" onclick="window.open('${s.link}', '_blank')">
                                üëÅ Ver
                            </button>
                            <input type="number" class="points-input" id="points-${s.id}" value="100" min="0">
                            <button class="review-btn approve" onclick="review('${s.id}', 'approved')">
                                ‚úì
                            </button>
                            <button class="review-btn deny" onclick="review('${s.id}', 'denied')">
                                ‚úó
                            </button>
                        </div>
                    ` : `
                        <div style="margin-top:0.75rem;font-size:0.85rem;color:${s.status === 'approved' ? 'var(--success)' : 'var(--danger)'}">
                            ${s.status === 'approved' ? '‚úì Aprobado (+' + (s.pointsAwarded || 100) + '‚≠ê)' : '‚úó Rechazado'}
                        </div>
                    `}
                </div>
            `).join('');
        }

        async function review(id, status) {
            const pointsEl = document.getElementById(`points-${id}`);
            const points = pointsEl ? parseInt(pointsEl.value) || 100 : 100;

            try {
                const res = await fetch(`/api/creator-submissions/${id}/review`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, pointsAwarded: points })
                });
                
                if (res.ok) {
                    // Update local data
                    const sub = submissions.find(s => s.id === id);
                    if (sub) {
                        sub.status = status;
                        sub.pointsAwarded = points;
                    }
                    updateStats();
                    renderSubmissions();
                }
            } catch (e) {
                alert('Error al procesar');
            }
        }

        function formatPhone(phone) {
            if (!phone) return '';
            const p = phone.replace(/\D/g, '');
            return p.length === 8 ? p.slice(0,4) + '-' + p.slice(4) : phone;
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('es-HN', { 
                day: 'numeric', 
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getPlatformIcon(platform) {
            const icons = {
                instagram: 'üì∏',
                tiktok: 'üéµ',
                facebook: 'üìò',
                youtube: '‚ñ∂Ô∏è',
                twitter: 'üê¶'
            };
            return icons[platform] || 'üì±';
        }

        loadSubmissions();
        // Refresh every 30 seconds
        setInterval(loadSubmissions, 30000);
    </script>
</body>
</html>
