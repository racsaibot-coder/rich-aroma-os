<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1410">
    <title>Shift Start | Rich Aroma</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --espresso: #5D4037;
            --caramel: #D4A574;
            --cream: #F5EDE4;
            --dark-bg: #0f0d0b;
            --card-bg: #1a1714;
            --text: #f5f0eb;
            --text-muted: #8a8078;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .title { font-size: 1.5rem; font-weight: 700; color: var(--caramel); }
        .employee-info { text-align: right; }
        .role-badge { 
            font-size: 0.75rem; 
            padding: 0.25rem 0.5rem; 
            background: rgba(212, 165, 116, 0.2); 
            color: var(--caramel);
            border-radius: 4px;
        }
        
        .blocker-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .card.completed { border-color: var(--success); opacity: 0.7; }
        .card.active { border-color: var(--caramel); box-shadow: 0 0 15px rgba(212, 165, 116, 0.1); }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .card-title { font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .status-icon { font-size: 1.25rem; }
        
        /* Contract */
        .contract-text {
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        canvas {
            background: white;
            border-radius: 8px;
            cursor: crosshair;
            width: 100%;
            height: 150px;
        }
        
        /* Tasks */
        .task-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .task-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid var(--text-muted);
            background: transparent;
            cursor: pointer;
            display: grid;
            place-items: center;
        }
        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }
        
        /* Start Button */
        .start-btn {
            width: 100%;
            padding: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            background: var(--text-muted);
            color: rgba(0,0,0,0.5);
            cursor: not-allowed;
            margin-top: 2rem;
            transition: all 0.3s;
        }
        .start-btn.ready {
            background: var(--success);
            color: white;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary { background: var(--caramel); color: var(--dark-bg); }
        .btn-clear { background: transparent; color: var(--text-muted); border: 1px solid var(--text-muted); }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">Start Shift Dashboard</div>
        <div class="employee-info">
            <div id="empName">Loading...</div>
            <div id="empRole" class="role-badge">...</div>
        </div>
    </div>
    
    <div class="blocker-container" id="container">
        <!-- Content injected by JS -->
    </div>
    
    <button id="startShiftBtn" class="start-btn" onclick="startShift()" disabled>Complete Tasks to Start</button>

    <script>
        const employeeId = localStorage.getItem('currentEmployeeId');
        if (!employeeId) window.location.href = '/timeclock'; // Redirect if no session

        let state = {
            contractSigned: false,
            pendingTraining: [],
            tasks: [],
            completedTasks: new Set()
        };

        async function init() {
            // Load Employee Info
            const empRes = await fetch('/api/employees');
            const empData = await empRes.json();
            const employee = empData.employees.find(e => e.id === employeeId);
            
            if (!employee) window.location.href = '/timeclock';
            
            document.getElementById('empName').textContent = employee.name;
            document.getElementById('empRole').textContent = employee.role.toUpperCase();
            
            // Load Blockers
            await Promise.all([
                checkContract(employeeId),
                checkTraining(employeeId),
                loadTasks(employee.role, employeeId)
            ]);
            
            render();
        }

        async function checkContract(id) {
            const res = await fetch(`/api/employee-os/contracts/${id}`);
            const data = await res.json();
            state.contractSigned = data.signed;
        }

        async function checkTraining(id) {
            const res = await fetch(`/api/employee-os/training/${id}`);
            const data = await res.json();
            state.pendingTraining = data.pending || [];
        }

        async function loadTasks(role, id) {
            const [tasksRes, logsRes] = await Promise.all([
                fetch(`/api/employee-os/tasks/${role}`),
                fetch(`/api/employee-os/tasks/log/${id}`)
            ]);
            
            const tasksData = await tasksRes.json();
            const logsData = await logsRes.json();
            
            state.tasks = tasksData.tasks || [];
            state.completedTasks = new Set(logsData.completedTaskIds || []);
        }

        function render() {
            const container = document.getElementById('container');
            container.innerHTML = '';
            
            let allClear = true;

            // 1. Contract Blocker
            if (!state.contractSigned) {
                allClear = false;
                container.innerHTML += `
                    <div class="card active">
                        <div class="card-header">
                            <div class="card-title"><span class="status-icon">‚úçÔ∏è</span> Sign Contract</div>
                        </div>
                        <div class="contract-text">
                            I hereby agree to the terms of employment at Rich Aroma...
                            (Full legalese would go here)
                        </div>
                        <div style="margin-bottom: 0.5rem; color: var(--text-muted);">Sign below:</div>
                        <canvas id="sigPad" width="600" height="150"></canvas>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn btn-clear" onclick="clearSig()">Clear</button>
                            <button class="btn btn-primary" onclick="submitContract()">Sign & Accept</button>
                        </div>
                    </div>
                `;
                setTimeout(initSigPad, 100);
            } else {
                container.innerHTML += `
                    <div class="card completed">
                        <div class="card-header">
                            <div class="card-title"><span class="status-icon">‚úÖ</span> Contract Signed</div>
                        </div>
                    </div>
                `;
            }

            // 2. Training Blocker
            if (state.pendingTraining.length > 0) {
                allClear = false;
                const module = state.pendingTraining[0]; // Show one at a time
                container.innerHTML += `
                    <div class="card active">
                        <div class="card-header">
                            <div class="card-title"><span class="status-icon">üéì</span> Training Required</div>
                        </div>
                        <h3>${module.title}</h3>
                        <div style="margin: 1rem 0; padding: 1rem; background: rgba(0,0,0,0.3); border-radius: 8px;">
                            ${module.content}
                        </div>
                        <button class="btn btn-primary" onclick="completeTraining(${module.id})">Mark as Complete</button>
                    </div>
                `;
            } else {
                 container.innerHTML += `
                    <div class="card completed">
                        <div class="card-header">
                            <div class="card-title"><span class="status-icon">‚úÖ</span> Training Up to Date</div>
                        </div>
                    </div>
                `;
            }

            // 3. Daily Tasks
            const remainingTasks = state.tasks.filter(t => !state.completedTasks.has(t.id));
            if (remainingTasks.length > 0) {
                allClear = false;
                const tasksHtml = state.tasks.map(t => {
                    const isDone = state.completedTasks.has(t.id);
                    return `
                        <div class="task-item" onclick="${!isDone ? `toggleTask(${t.id})` : ''}">
                            <div class="task-checkbox ${isDone ? 'checked' : ''}">${isDone ? '‚úì' : ''}</div>
                            <div style="${isDone ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.task_description}</div>
                        </div>
                    `;
                }).join('');

                container.innerHTML += `
                    <div class="card active">
                        <div class="card-header">
                            <div class="card-title"><span class="status-icon">üìã</span> Daily Checklist</div>
                        </div>
                        <div class="task-list">
                            ${tasksHtml}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML += `
                    <div class="card completed">
                        <div class="card-header">
                            <div class="card-title"><span class="status-icon">‚úÖ</span> Daily Tasks Ready</div>
                        </div>
                    </div>
                `;
            }

            // Update Main Button
            const btn = document.getElementById('startShiftBtn');
            if (allClear) {
                btn.disabled = false;
                btn.classList.add('ready');
                btn.textContent = 'Start Shift üöÄ';
            } else {
                btn.disabled = true;
                btn.classList.remove('ready');
                btn.textContent = 'Complete Requirements to Start';
            }
        }

        // --- Actions ---

        // Signature Pad
        let canvas, ctx, isDrawing = false;
        function initSigPad() {
            canvas = document.getElementById('sigPad');
            if(!canvas) return;
            ctx = canvas.getContext('2d');
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
            canvas.addEventListener('touchend', endDraw);
        }
        
        function startDraw(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }
        
        function endDraw() { isDrawing = false; }
        
        function clearSig() {
            if(!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        async function submitContract() {
            if(!canvas) return;
            const dataUrl = canvas.toDataURL();
            await fetch('/api/employee-os/contracts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employeeId,
                    contractText: "Standard Agreement",
                    signatureDataUrl: dataUrl
                })
            });
            await checkContract(employeeId);
            render();
        }

        async function completeTraining(moduleId) {
            await fetch('/api/employee-os/training/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employeeId, moduleId, score: 100 })
            });
            await checkTraining(employeeId);
            render();
        }

        async function toggleTask(taskId) {
            await fetch('/api/employee-os/tasks/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employeeId, taskId })
            });
            await loadTasks(document.getElementById('empRole').textContent.toLowerCase(), employeeId);
            render();
        }

        function startShift() {
            window.location.href = '/order';
        }

        init();
    </script>
</body>
</html>
