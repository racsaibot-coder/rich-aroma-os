<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rich Aroma | POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#C9A66B',
                        dark: '#1E1610',
                        charcoal: '#2C241E',
                        cream: '#F5F5F0',
                        success: '#10B981',
                        danger: '#EF4444'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Playfair Display', 'serif']
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #1E1610; color: #F5F5F0; font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(44, 36, 30, 0.95); border: 1px solid rgba(201, 166, 107, 0.1); backdrop-filter: blur(10px); }
        .active-tab { background-color: #C9A66B; color: #1E1610; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1E1610; }
        ::-webkit-scrollbar-thumb { background: #2C241E; border-radius: 3px; }
        
        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar (Navigation) -->
    <aside class="w-20 bg-dark border-r border-white/5 flex flex-col items-center py-6 gap-8 z-20">
        <div class="w-10 h-10 rounded-full bg-gold flex items-center justify-center text-dark text-xl font-bold mb-4">
            <i class="fas fa-lion"></i>
        </div>
        
        <button class="w-12 h-12 rounded-xl bg-gold/10 text-gold flex items-center justify-center hover:bg-gold hover:text-dark transition-all active-tab" onclick="switchTab('pos')">
            <i class="fas fa-cash-register text-lg"></i>
        </button>
        <button class="w-12 h-12 rounded-xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-gold hover:text-dark transition-all" onclick="window.location.href='/dashboard.html'">
            <i class="fas fa-list-ul text-lg"></i>
        </button>
        <button class="w-12 h-12 rounded-xl bg-white/5 text-white/40 flex items-center justify-center hover:bg-gold hover:text-dark transition-all" onclick="alert('Customers Module coming soon!')">
            <i class="fas fa-users text-lg"></i>
        </button>
        
        <div class="mt-auto">
            <button onclick="document.getElementById('close-modal').classList.remove('hidden')" class="w-12 h-12 rounded-xl bg-danger/10 text-danger flex items-center justify-center hover:bg-danger hover:text-white transition-all">
                <i class="fas fa-power-off text-lg"></i>
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Toast Container -->
        <div id="toast-container" class="absolute top-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

        <!-- Left: Menu Grid -->
        <div class="flex-1 p-6 overflow-y-auto flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 shrink-0">
                <div>
                    <h1 class="text-2xl font-bold font-display text-gold">Buenos D√≠as, NeeNee üëã</h1>
                    <p class="text-white/40 text-sm">Caja Principal ‚Ä¢ <span id="clock" class="font-mono">--:--</span></p>
                </div>
                <div class="flex gap-2" id="category-filters">
                    <!-- Filters injected here -->
                    <button onclick="filterMenu('all')" class="px-4 py-2 rounded-lg bg-gold text-dark font-bold text-sm hover:opacity-90 transition-colors">Todo</button>
                </div>
            </div>

            <!-- Grid -->
            <div class="grid grid-cols-3 xl:grid-cols-4 gap-4 pb-20" id="menu-grid">
                <!-- Items injected by JS -->
                <div class="col-span-full text-center py-10 text-white/20">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Cargando men√∫...</p>
                </div>
            </div>
        </div>

        <!-- Right: Current Ticket -->
        <div class="w-96 bg-charcoal border-l border-white/5 flex flex-col shadow-2xl relative z-10">
            
            <!-- Customer Selector -->
            <div class="p-4 border-b border-white/5">
                <button class="w-full py-3 px-4 bg-dark rounded-xl border border-white/10 flex items-center justify-between hover:border-gold/30 transition-all group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white/40 group-hover:text-gold group-hover:bg-gold/10">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <span class="text-white/60 font-medium group-hover:text-white">Cliente General</span>
                    </div>
                    <i class="fas fa-chevron-right text-xs text-white/20"></i>
                </button>
            </div>

            <!-- Ticket Items -->
            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="ticket-items">
                <!-- Empty State -->
                <div class="h-full flex flex-col items-center justify-center text-white/20">
                    <i class="fas fa-receipt text-4xl mb-3"></i>
                    <p class="text-sm">Ticket Vac√≠o</p>
                </div>
            </div>

            <!-- Totals -->
            <div class="p-6 bg-dark border-t border-white/5 space-y-4">
                <div class="flex justify-between text-sm text-white/60">
                    <span>Subtotal</span>
                    <span id="subtotal-display">L 0.00</span>
                </div>
                <div class="flex justify-between text-sm text-white/60">
                    <span>ISV (<span id="tax-rate-display">15</span>%)</span>
                    <span id="tax-display">L 0.00</span>
                </div>
                <div class="flex justify-between items-end border-t border-white/10 pt-4">
                    <span class="text-white/40 font-medium">Total</span>
                    <span class="text-3xl font-bold font-display text-gold" id="total-display">L 0.00</span>
                </div>


                <!-- Discounts Button -->
                <button onclick="toggleDiscounts()" class="w-full py-3 mb-2 bg-charcoal hover:bg-white/5 border border-white/5 rounded-xl text-white/60 hover:text-white transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-percent"></i>
                    <span>Aplicar Descuento</span>
                </button>

                <!-- Pay Button -->
                <button id="pay-btn" onclick="submitOrder()" disabled class="w-full py-4 bg-white/10 text-white/20 font-bold text-lg rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 cursor-not-allowed">
                    <span>COBRAR</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- BLIND CLOSE MODAL -->
        <div id="close-modal" class="hidden absolute inset-0 bg-black/95 backdrop-blur-md z-50 flex items-center justify-center p-4">
            <div class="bg-dark border border-white/10 rounded-2xl w-full max-w-md p-8 shadow-2xl text-center">
                <div class="w-16 h-16 rounded-full bg-gold/20 text-gold flex items-center justify-center text-3xl mx-auto mb-6">
                    <i class="fas fa-cash-register"></i>
                </div>
                
                <h2 class="text-2xl font-bold text-white mb-2">Cierre de Caja</h2>
                <p class="text-white/40 mb-8 text-sm">Ingresa el efectivo contado F√çSICAMENTE.</p>

                <div class="mb-6">
                    <label class="block text-left text-xs text-gold font-bold mb-2 uppercase tracking-widest">Efectivo en Caj√≥n (Lempiras)</label>
                    <input type="number" id="counted-cash" placeholder="0.00" class="w-full bg-white/5 border border-white/20 rounded-xl py-4 px-6 text-3xl text-white font-mono text-center focus:border-gold focus:outline-none focus:ring-1 focus:ring-gold transition-all">
                </div>
                
                <div class="mb-8">
                    <label class="block text-left text-xs text-gold font-bold mb-2 uppercase tracking-widest">Notas / Justificaci√≥n</label>
                    <textarea id="close-notes" placeholder="Ej: Gastos de caja chica..." class="w-full bg-white/5 border border-white/20 rounded-xl p-4 text-white placeholder-white/20 focus:border-gold focus:outline-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="document.getElementById('close-modal').classList.add('hidden')" class="py-4 rounded-xl bg-white/5 hover:bg-white/10 text-white font-bold transition-all">Cancelar</button>
                    <button onclick="submitBlindClose()" class="py-4 rounded-xl bg-gold hover:bg-yellow-500 text-dark font-bold transition-all shadow-lg shadow-gold/20">
                        <i class="fas fa-lock mr-2"></i> CERRAR TURNO
                    </button>
                </div>
            </div>
        </div>
        
        <!-- DISCOUNT MODAL (Existing) -->
        <div id="discount-modal" class="hidden absolute inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-dark border border-white/10 rounded-2xl w-full max-w-md p-6 shadow-2xl transform transition-all scale-100">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-white"><i class="fas fa-tags text-gold mr-2"></i> Descuentos</h2>
                    <button onclick="toggleDiscounts()" class="text-white/40 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                </div>
                
                <div class="space-y-3">
                    <button onclick="applyDiscount('senior')" class="w-full p-4 bg-charcoal hover:bg-white/5 border border-white/5 rounded-xl flex items-center justify-between group transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-lg"><i class="fas fa-user-clock"></i></div>
                            <div class="text-left">
                                <h3 class="font-bold text-white group-hover:text-gold">Tercera Edad</h3>
                                <p class="text-xs text-white/40">25% (Solo consumo personal)</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-white/20"></i>
                    </button>

                    <button onclick="applyDiscount('responder')" class="w-full p-4 bg-charcoal hover:bg-white/5 border border-white/5 rounded-xl flex items-center justify-between group transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center text-lg"><i class="fas fa-ambulance"></i></div>
                            <div class="text-left">
                                <h3 class="font-bold text-white group-hover:text-gold">Primeros Auxilios</h3>
                                <p class="text-xs text-white/40">15% (Bomberos, Cruz Roja)</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-white/20"></i>
                    </button>
                    
                    <button onclick="applyDiscount('custom')" class="w-full p-4 bg-charcoal hover:bg-white/5 border border-white/5 rounded-xl flex items-center justify-between group transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-white/10 text-white/60 flex items-center justify-center text-lg"><i class="fas fa-pencil-alt"></i></div>
                            <div class="text-left">
                                <h3 class="font-bold text-white group-hover:text-gold">Manual / Cortes√≠a</h3>
                                <p class="text-xs text-white/40">Autorizaci√≥n de Gerente</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-white/20"></i>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // ... (Clock code) ...

        // State
        let allCategories = [];
        let allItems = [];
        let cart = [];
        let activeDiscount = null; // { type: 'senior', percent: 0.25, items: [] }
        let taxRate = 0.15;
        let isProcessing = false;

        // ... (LoadMenu, RenderFilters, etc) ...

        function toggleDiscounts() {
            const modal = document.getElementById('discount-modal');
            modal.classList.toggle('hidden');
        }
        
        function applyDiscount(type) {
            if (cart.length === 0) return;
            
            // For MVP: Apply to WHOLE cart for now, or last item?
            // "Senior" usually applies to specific items.
            // Let's implement a simple "Whole Cart" version first for speed,
            // or "Select Items" logic is complex.
            // Compromise: Apply to ALL items for now, assuming cashier split the check if needed.
            // Or prompt "Apply to Last Item?"
            
            // Let's do: Apply to Whole Order for simplicity in this version.
            
            let percent = 0;
            if(type === 'senior') percent = 0.25;
            if(type === 'responder') percent = 0.15;
            if(type === 'custom') {
                const manual = prompt("Porcentaje de descuento (0-100):");
                if(manual) percent = parseFloat(manual) / 100;
            }
            
            activeDiscount = { type, percent };
            toggleDiscounts();
            renderCart();
            showToast(`Descuento ${(percent*100).toFixed(0)}% Aplicado`, 'success');
        }

        function renderCart() {
            // ... (Previous logic) ...
            
            // Recalculate with Discount
            let subtotal = 0;
            cart.forEach(item => subtotal += item.price);
            
            let discountAmount = 0;
            if(activeDiscount) {
                discountAmount = subtotal * activeDiscount.percent;
            }
            
            const subtotalAfterDiscount = subtotal - discountAmount;
            const tax = subtotalAfterDiscount * taxRate;
            const total = subtotalAfterDiscount + tax;

            // Update UI
            container.innerHTML = html; // (Your existing html loop)
            subtotalDisplay.innerText = `L ${subtotal.toFixed(2)}`;
            
            // Show Discount Line if active
            if(activeDiscount) {
                // Hack: Inject discount line into Tax Display area or create new element
                // For now, let's append it to subtotal text or just log it
                 subtotalDisplay.innerHTML = `L ${subtotal.toFixed(2)} <span class="text-red-400 text-xs block">- L ${discountAmount.toFixed(2)} (${(activeDiscount.percent*100).toFixed(0)}%)</span>`;
            }
            
            taxDisplay.innerText = `L ${tax.toFixed(2)}`;
            totalDisplay.innerText = `L ${total.toFixed(2)}`;
            
            // ... (Pay Btn logic) ...
        }

        async function submitBlindClose() {
            const counted = parseFloat(document.getElementById('counted-cash').value);
            const notes = document.getElementById('close-notes').value;

            if (isNaN(counted)) {
                alert("Ingresa el monto contado");
                return;
            }

            try {
                // Here we would call the API
                // For MVP, we simulate the variance check
                
                // Mock System Expected:
                const expected = 5000; // Example
                const variance = counted - expected;
                const varianceColor = variance < 0 ? 'text-red-500' : 'text-green-500';
                
                // Show Result Alert (In production this is sent to Admin only, Cashier sees simple success)
                alert(`Cierre Enviado.\n\nContado: L ${counted.toFixed(2)}\nEsperado: L ${expected.toFixed(2)}\nDiferencia: L ${variance.toFixed(2)}\n\nReporte enviado a Gerencia.`);
                
                // Close modal
                document.getElementById('close-modal').classList.add('hidden');
                
                // Send Telegram Alert (Mock)
                console.log(`[ALERT] Blind Close: Counted ${counted}, Expected ${expected}, Variance ${variance}. Notes: ${notes}`);

            } catch (e) {
                alert("Error al cerrar caja");
            }
        }

        async function submitOrder() {
            if (isProcessing || cart.length === 0) return;
            isProcessing = true;
            
            const payBtn = document.getElementById('pay-btn');
            const originalText = payBtn.innerHTML;
            payBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Procesando...`;

            try {
                // Calculate totals
                const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
                const tax = subtotal * taxRate;
                const total = subtotal + tax;

                // Prepare Payload
                const payload = {
                    items: cart.map(i => ({ id: i.id, quantity: 1, price: i.price, name: i.name })),
                    subtotal: subtotal,
                    tax: tax,
                    total: total,
                    paymentMethod: 'cash', // Default for now
                    customerId: null // Default generic
                };

                const res = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error('Failed to create order');
                
                const order = await res.json();
                
                // Success
                playSound('success');
                showToast(`Orden #${order.order_number} Creada!`, 'success');
                cart = [];
                renderCart();

            } catch (e) {
                console.error("Order error:", e);
                showToast('Error al crear orden', 'error');
            } finally {
                isProcessing = false;
                payBtn.innerHTML = originalText;
            }
        }

        // Utils
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            const colors = type === 'success' ? 'bg-success text-white' : (type === 'error' ? 'bg-danger text-white' : 'bg-charcoal text-white border border-gold');
            
            el.className = `toast pointer-events-auto px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 font-bold ${colors}`;
            el.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : (type === 'error' ? 'times-circle' : 'info-circle')}"></i>
                ${msg}
            `;
            
            container.appendChild(el);
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(100%)';
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        function playSound(type) {
            // Placeholder for sound effects
            // const audio = new Audio(`/sounds/${type}.mp3`);
            // audio.play().catch(e => {});
        }
    </script>
</body>
</html>
