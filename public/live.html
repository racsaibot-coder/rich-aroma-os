<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rich Aroma | LIVE DROP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#C9A66B',
                        dark: '#1E1610',
                        danger: '#EF4444'
                    },
                    fontFamily: {
                        display: ['Playfair Display', 'serif'],
                        sans: ['Inter', 'sans-serif']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #1E1610; color: #F5F5F0; font-family: 'Inter', sans-serif; }
        .ticket-bg {
            background-image: radial-gradient(circle at 50% -10px, transparent 20px, #C9A66B 21px);
            background-size: 100% 40px;
            background-repeat: repeat-x;
        }
        .ticket-stub {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, #1E1610 11px), radial-gradient(circle at 100% 50%, transparent 10px, #1E1610 11px);
            background-position: 0 0, 0 0;
            background-size: 20px 20px;
            background-repeat: no-repeat;
        }
        .scan-line {
            width: 100%;
            height: 2px;
            background: #EF4444;
            position: absolute;
            top: 0;
            left: 0;
            animation: scan 2s infinite;
        }
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        /* Custom Checkbox */
        .check-hidden { display: none; }
        .check-label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .check-hidden:checked + .check-label {
            background: rgba(201, 166, 107, 0.2);
            border-color: #C9A66B;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">

    <!-- Background Effects -->
    <div class="absolute inset-0 z-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
    <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-gold/10 to-transparent pointer-events-none"></div>

    <!-- MAIN CONTAINER -->
    <div id="app" class="relative z-10 w-full max-w-md mx-auto">
        
        <!-- HEADER -->
        <div class="text-center mb-8">
            <div class="inline-block px-3 py-1 bg-red-600 text-white text-xs font-bold tracking-widest rounded-full mb-4 animate-pulse-slow">
                ðŸ”´ LIVE DROP
            </div>
            <h1 class="text-4xl font-bold font-display text-gold mb-2" id="header-title">Flash Sale</h1>
            <p class="text-white/60">Oferta exclusiva de la transmisiÃ³n</p>
        </div>

        <!-- 1. ACTIVE DROP CARD -->
        <div id="drop-card" class="bg-white/5 backdrop-blur-xl border border-gold/30 rounded-2xl p-1 shadow-2xl transform transition-all">
            <!-- Product Image Area -->
            <div class="relative bg-dark rounded-xl overflow-hidden aspect-video group">
                <img src="https://images.unsplash.com/photo-1541167760496-1628856ab772?q=80&w=1000&auto=format&fit=crop" id="product-img" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" alt="Product">
                
                <!-- Countdown Overlay -->
                <div class="absolute inset-0 flex items-center justify-center bg-black/40">
                    <div class="text-center">
                        <p class="text-xs uppercase tracking-widest text-white/80 mb-1">Termina en</p>
                        <div class="text-4xl font-mono font-bold text-white flex gap-2">
                            <span id="timer-min">04</span>:<span id="timer-sec">59</span>
                        </div>
                    </div>
                </div>

                <!-- Stock Counter -->
                <div class="absolute top-3 right-3 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow">
                    ðŸ”¥ Solo quedan <span id="stock-count">--</span>
                </div>
            </div>

            <!-- Details -->
            <div class="p-6 text-center">
                <h2 class="text-2xl font-bold text-white mb-1" id="product-name">Cargando...</h2>
                <div class="flex items-center justify-center gap-3 mb-6">
                    <span class="text-white/40 line-through text-lg" id="original-price">L. --</span>
                    <span class="text-gold text-3xl font-bold" id="sale-price">L. --</span>
                </div>

                <!-- FORM -->
                <div class="space-y-4">
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-phone text-white/40"></i>
                        </div>
                        <input type="tel" id="phone" placeholder="Tu nÃºmero de celular" class="w-full bg-white/10 border border-white/20 rounded-xl py-4 pl-10 pr-4 text-white placeholder-white/40 focus:outline-none focus:border-gold focus:ring-1 focus:ring-gold transition-all text-lg font-mono">
                    </div>

                    <!-- Payment Option Switch -->
                    <div class="text-left bg-dark/30 p-3 rounded-xl">
                        <input type="checkbox" id="pay-now-check" class="check-hidden" onchange="togglePinInput()">
                        <label for="pay-now-check" class="check-label group">
                            <div class="w-5 h-5 rounded border border-white/40 flex items-center justify-center group-hover:border-gold">
                                <i class="fas fa-check text-gold text-xs opacity-0" id="check-icon"></i>
                            </div>
                            <div class="flex-1">
                                <span class="text-sm font-bold text-gold block">Pagar con Rico Cash</span>
                                <span class="text-xs text-white/40">SÃ¡ltate la fila en caja</span>
                            </div>
                            <i class="fas fa-wallet text-white/20 text-xl"></i>
                        </label>
                        
                        <!-- PIN Input (Hidden by default) -->
                        <div id="pin-container" class="hidden mt-3 pt-3 border-t border-white/10">
                            <label class="text-xs text-white/40 mb-1 block">Ingresa tu PIN (4 dÃ­gitos)</label>
                            <input type="password" id="pin" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" class="w-full bg-white/5 border border-white/10 rounded-lg py-2 px-3 text-center text-white tracking-[0.5em] text-xl focus:border-gold focus:outline-none">
                        </div>
                    </div>

                    <button onclick="handleAction()" id="action-btn" class="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-4 rounded-xl text-lg shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span id="btn-text">RESERVAR (Pagar en Caja)</span>
                        <i class="fas fa-ticket-alt"></i>
                    </button>
                    
                </div>
            </div>
        </div>

        <!-- 2. LOADING STATE (Hidden) -->
        <div id="loading-state" class="hidden text-center py-20">
            <div class="inline-block w-16 h-16 border-4 border-gold border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-white/60 animate-pulse">Procesando...</p>
        </div>

        <!-- 3. GOLDEN TICKET (Hidden) -->
        <div id="golden-ticket" class="hidden transform transition-all duration-500 scale-95 opacity-0">
            <div class="bg-gold text-dark rounded-3xl overflow-hidden shadow-2xl relative">
                <!-- Top Rip -->
                <div class="absolute top-0 left-0 w-full h-4 bg-dark ticket-bg opacity-20"></div>

                <div class="p-8 text-center relative z-10">
                    <div class="w-16 h-16 bg-dark text-gold rounded-full flex items-center justify-center text-2xl mx-auto mb-4 shadow-inner">
                        <i class="fas fa-check" id="ticket-icon"></i>
                    </div>
                    
                    <h2 class="text-3xl font-bold font-display mb-2" id="ticket-title">Â¡RESERVADO!</h2>
                    <p class="opacity-80 mb-6" id="ticket-subtitle">Muestra esta pantalla en caja</p>

                    <div class="bg-white p-4 rounded-xl mb-6 relative overflow-hidden">
                        <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">CÃ³digo de Canje</p>
                        <p class="text-4xl font-mono font-bold tracking-widest text-dark" id="ticket-code">----</p>
                        <div class="scan-line opacity-50"></div>
                    </div>

                    <div class="flex justify-between items-center text-sm font-mono opacity-70 border-t border-dark/10 pt-4">
                        <span>Estado:</span>
                        <span class="font-bold uppercase" id="ticket-status">Pendiente de Pago</span>
                    </div>
                </div>

                <!-- Bottom Action -->
                <div class="bg-dark/10 p-4 text-center cursor-pointer hover:bg-dark/20 transition-colors" onclick="location.reload()">
                    <span class="text-xs font-bold uppercase tracking-widest opacity-60">Cerrar</span>
                </div>
            </div>
            
            <p class="text-center text-white/40 text-xs mt-6">No cierres esta pestaÃ±a hasta canjear.</p>
        </div>

    </div>

    <script>
        // Init
        fetchStatus();
        setInterval(fetchStatus, 3000);

        async function fetchStatus() {
            try {
                const res = await fetch('/api/live/status');
                const data = await res.json();
                
                if(!data.active || data.stock <= 0) {
                    // Show sold out state if needed, or just update numbers
                }

                document.getElementById('product-name').innerText = data.product || "Flash Sale";
                document.getElementById('sale-price').innerText = "L. " + data.price;
                document.getElementById('original-price').innerText = "L. " + (data.originalPrice || 0);
                document.getElementById('stock-count').innerText = data.stock;
                
                // Only update img if changed to avoid flicker
                const img = document.getElementById('product-img');
                if(img.src !== data.imageUrl) img.src = data.imageUrl;

            } catch(e) {}
        }

        function togglePinInput() {
            const isChecked = document.getElementById('pay-now-check').checked;
            const pinContainer = document.getElementById('pin-container');
            const checkIcon = document.getElementById('check-icon');
            const btnText = document.getElementById('btn-text');
            const btn = document.getElementById('action-btn');

            if(isChecked) {
                pinContainer.classList.remove('hidden');
                checkIcon.classList.remove('opacity-0');
                btnText.innerText = "PAGAR AHORA";
                btn.classList.remove('bg-white/10');
                btn.classList.add('bg-gold', 'text-dark');
                document.getElementById('pin').focus();
            } else {
                pinContainer.classList.add('hidden');
                checkIcon.classList.add('opacity-0');
                btnText.innerText = "RESERVAR (Pagar en Caja)";
                btn.classList.add('bg-white/10');
                btn.classList.remove('bg-gold', 'text-dark');
            }
        }

        async function handleAction() {
            const phone = document.getElementById('phone').value;
            const isPayNow = document.getElementById('pay-now-check').checked;
            const pin = document.getElementById('pin').value;

            if(phone.length < 8) {
                alert("NÃºmero de celular invÃ¡lido");
                return;
            }

            if(isPayNow && pin.length !== 4) {
                alert("Ingresa tu PIN de 4 dÃ­gitos");
                return;
            }

            // Transition
            document.getElementById('drop-card').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');

            try {
                let res;
                if(isPayNow) {
                    // Call Payment API
                    res = await fetch('/api/live/pay', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ phone, pin })
                    });
                } else {
                    // Call Reserve API
                    res = await fetch('/api/live/claim', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ phone })
                    });
                }

                const data = await res.json();

                if(!data.success) {
                    alert(data.error || "Error al procesar");
                    location.reload();
                    return;
                }

                // Show Ticket
                showTicket(data.code, data.paid);

            } catch(e) {
                alert("Error de conexiÃ³n");
                location.reload();
            }
        }

        function showTicket(code, isPaid) {
            document.getElementById('loading-state').classList.add('hidden');
            const ticket = document.getElementById('golden-ticket');
            
            document.getElementById('ticket-code').innerText = code;
            
            if(isPaid) {
                document.getElementById('ticket-title').innerText = "Â¡COMPRA EXITOSA!";
                document.getElementById('ticket-subtitle').innerText = "Ya pagado. Recoge en barra.";
                document.getElementById('ticket-status').innerText = "PAGADO (VIP)";
                document.getElementById('ticket-status').className = "font-bold uppercase text-green-600";
                document.getElementById('ticket-icon').className = "fas fa-bolt";
            } else {
                // Default
            }

            ticket.classList.remove('hidden');
            setTimeout(() => {
                ticket.classList.remove('scale-95', 'opacity-0');
                confetti({
                    particleCount: 150,
                    spread: 80,
                    origin: { y: 0.6 },
                    colors: isPaid ? ['#C9A66B', '#FFD700'] : ['#C9A66B', '#FFFFFF']
                });
            }, 50);
        }

        // Timer Logic
        let time = 300; 
        setInterval(() => {
            if(time > 0) {
                time--;
                const m = Math.floor(time / 60).toString().padStart(2, '0');
                const s = (time % 60).toString().padStart(2, '0');
                document.getElementById('timer-min').innerText = m;
                document.getElementById('timer-sec').innerText = s;
            }
        }, 1000);
    </script>
</body>
</html>
